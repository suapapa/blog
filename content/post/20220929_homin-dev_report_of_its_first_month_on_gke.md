---
title: Homin.dev, k8s 클러스터 월 비용+수익 전격 공개!
date: 2022-09-29T05:19:54Z
tags:
- k8s
- gke
- golang
featured_image: ""
description: ""
toc: true
---

[도메인을 와장창 구매](https://homin.dev/asset/blog/img/20220903_homin-dev_domain_godday.png)하고,
GKE에 k8s 클러스터를 꾸리고 [개인사이트](https://homin.dev/blog/post/20220908_homin-dev_with_k8s/)를 만들기
시작한 지 한달이 지나가고 있습니다.

단기간에 정말 많이 배웠고 재미있게 운영하고 있습니다.
그동안 한 일들과 현재 상태를 공유합니다.

## 현재의 구성

현재의 구성은 다음과 같습니다.

![20220929_homin-dev.png](https://homin.dev/asset/blog/img/20220929_homin-dev.png)


## 그동안 한 일

초반에 비해 세 가지 정도의 큰 변화가 있었습니다. (물론 티는 안 납니다 ㅋ):

### ingress-proxy 에서 대문 웹 페이지 분리

이 사이트를 꾸리게 된 계기는 여러 서비스의 개인 페이지에 제가 쉽게 접근하기 위함이었습니다.

> 예: homin.dev/yt -> 내 유튜브 채널, homin.dev/fb -> 내 페이스북 페이지

ingress-proxy에서 http redirection 으로 할 수 있는데, 그 포드는 kubeip를 통해 고정아이피를 받아야 되기 때문에,
1 replica 만 가능하더라구요. 그리고 머신도 e2-micro로 제일 후진?걸 쓰고 있어서 거기서 대문페이지를 서버사이드
서버 사이드렌더링하고 있자니 느낌상 좀 굼뜬기분이라 분리했습니다.

ingress node는 이제 외부 서비스로 이동하기 위한 http redirection, work 노드내의 내 서비스들로 이동하기 위한
http reverse proxy 만을 제공합니다.

인증서 관리 부분도, 전 포스팅에서 꼭 수동으로 해야한다고 했지만, 자동화를 시도중이며 이는 밑에서 다시 언급하겠습니다.

### gh-pages의 사이트들 이전

보시는 분들이 [후원](https://homin.dev/support)을 쉽게 할 수 있다면 손쉽게 클러스터 운영비를 벌 수 있을거라고 생각했지만
현실은 지인들(이미 감사했지만 또 감사 드립니다. 형님들 ㅎㅎ)을 제외하곤 아무도 거기를 통한 후원을 하지 않으시더군요. 부끄러우신가봐요. :)

그래서 구글 Adsense 광고를 붙였습니다.

첫 심사 시도에는 제 사이트에는 대문페이지 말고 아무것도 없다며 (그게 의도인데!) 반려당하더라구요;
그래서 [과거를 복구해 풍부해진 블로그](https://homin.dev/blog/post/20220916_restore_suapapas_blog/)와
[outdated 된 내용이지만 뭔가가 들어있는 개인위키 복구분](https://homin.dev/blog/post/20220914_reopen_wiki/)을
가지고 다시 심사를 요청해 성공했습니다.

> 심사 후 10일정도 동안, $6정도를 벌었습니다. 감사합니다.


### 대문 페이지 꾸미기 자력 해결

제 사이트는 모들걸 직접 하는데 의미를 두고자 시작했기때문에 [대문 페이지](http://homin.dev)의 웹 화면도 Go 언어의 template 패키지를 사용한
서버사이드 렌더링 입니다. html을 한땀한땀 꾀었다는 이야기죠.
그러고 보니 CSS는 정말 어떻게 해야하는지 모르겠어서, 숨고 서비스에 의뢰를 했었습니다. (숨고 좋아요!)

견적이 왔는데, 전 10만원 정도의 몇시간 짜리 일 일것이라고 생각, 60만원에 일주일 이상의 일정을 부르더라구요. 아.. 이건 좀.

지인 총 동원해도 답이 없던 차에, 참고하려고 블로그의 HTML을 보다가 [Tachyons](http://tachyons.io/)을 알게 되었습니다.
간단히 설명하면 태그의 class에 미리 정한 특성들을 나열해 코드로 웹을 디자인 하는 프로젝트 입니다.

뚝딱! 반나절 만에 [현재의 모습](https://homin.dev/asset/blog/img/20220930_homin-dev_ingress.png)이 완성되었습니다.

> CSS는 결국 1도 손대지 않았습니다.


## 스팟 노드의 특성

스팟노드의 특성을 알 수 있었는데, 지난 포스팅에서 인증서(ssl-cert)를 노드의 부트디스크에 저장했던 건
포드를 재시작할때는 유용했지만, 스팟노드의 특성 상, 노드가 터졌을때는 그냥 날아가더라구요;

스팟 노드는 말 그대로 아무때나 터집니다. 어쩔땐 일주일 가량 유지되기도 하고, 몇시간 주기로 터지기도 합니다.

![failed_pos.png](https://homin.dev/asset/blog/img/failed_pos.png)

다행히 마스터노드가 터진 워크노드들을 복구해 자동으로 복구해 주는 것 같습니다.
대신 남아있는 찌꺼기는 아래의, 상태가 Fail인 모든 포드 삭제하는, 명령어등을 실행해 수동으로 정리하고 있습니다.

```bash
k delete pods --field-selector status.phase=Failed -A
```

또한, 지난 포스팅에서 인증서를 노드에 저장한다고 했는데... 네 스팟 터지면 날아갑니다.
인증서가 날아가면 노드과 서비스들이 모두 살아있어도 FQDN으로 접근이 안되니까 장애 상황 이더군요.

> 인증서 만을 위해 최소 단위가 10G persistace disk에 별도 지출은 하기 싫고...

우선은 ingress-proxy에 Telegram bot 으로 앱을 시작과 종료시에 메시지를 남기게 해서;
몇 차례 수동으로 인증서를 재 생성했습니다.

다행히 `yes` 명령어등을 조합해 사용자 입력없이 인증서를 새로 만드는 스크립트를 작성했는데,
아직까지 미묘하게 동작이 안되는 부분이 있어서 튜닝중입니다.

> 우리는 답을 찾을 것이다. 늘 그랬듯이. - 인터스텔라


## GKE 월 비용 대 공개!

각설하고 비용 공개합니다.
[만원이 안 될거라는 예상](https://homin.dev/asset/blog/img/homin_dev_gke_price_estimation.png)은 빗나갔습니다.

### 일 평균 비용

보통은 일당 400원 꼴로 비용이 나가더라구요.

![20220930_homin-dev_billing_report_01.png](https://homin.dev/asset/blog/img/20220930_homin-dev_billing_report_01.png)

9월 15일에 추가 지출이 있었던 것은 블로그의 asset을 여기저기 옮겨보다가, 실수로, 모두 다운로드 받았을때의 비용입니다.

> 들어올때는 맘대로지만 나갈때는 돈이란다.

보시면, 미국에서 한국으로의 트래픽에도 비용이 나가고 있는데, 저는 거의 100%의 인입이 한국에서 일어나고 있어서 좀 아깝다는 생각이 들더라구요.

> 아이오와 리젼이 싸길래 무지성으로 골랐는데, 한국 리전이 조금 비싸도 네트워크비가 빠지니
> 새로 프로젝트를 시작하시는 분들은 잘 고려해 보시길 바랍니다.

또한, work node에 서비스를 잔뜩 담을생각으로 20G 디스크를 신청했는데 아직 1G도 못 썼습니다.

> 4G 정도는 노드의 OS에서 기본으로 먹고 들어가므로 10G 디스크는 가용 6G, 20G는 가용 16기가 뭐 이렇습니다.
> 비용 계산기에서는 10G에 월 500원 더 나간다던데,
> SKU상으로는 상관없이 사용량(500M)에 대한 비용만 나가고 있는것도 같고.. 아직 잘 모르겠습니다.

그럼, 400원 x 30일 = 12000원이면 되는가?

### 실제 청구 예상 비용

![20220930_homin-dev_billing_report_02.png](https://homin.dev/asset/blog/img/20220930_homin-dev_billing_report_02.png)

> 와장창!! 월 금액 27,000원 예상!

9월 21일에 네트워킹 비용으로 13,000원이 추가로 청구되었습니다. 하루만 그래서 DDOS공격이라도 당했나? 했는데
확인해보니, MQTT서버가 안되기 시작해 이것저것 살펴보다가 Firewall Insights 라는 인공지능 방화벽 로그 분석기를 켰던 비용이었습니다.

> 그걸 사용하고도 MQTT서버로 접근이 안되는 이유는 못 찾았습니다. 아예 방화벽에 hit가 안되는 것 같습니다...
> 그래서 현재의 [방명록](https://homin.dev/gb)는 영수증 프린터로 안 나오고 그냥 Telegram 메시지로 받고 있습니다. 아쉬워라...

뭔가 자동이라고 하고, 좋아보이는 건 돈 나간다는 이야기구나! 라는 좋은 경험을 쌓았습니다. ㅎㅎ

## 마무리

[Diagrams Sandbox](https://homin.dev/dsb/)를 사용해 다이어그램을 그리며 설명한 영상 남깁니다. 긴 글 봐 주셔서 감사합니다.

{{< youtube MH3aYQyRrBQ >}}

끝!